<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WIP Timesheet – MVP2 Batch</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f3f5f8;
    margin: 0; padding: 20px;
    color: #222;
  }

  h1 {
    margin-top: 0;
    font-size: 26px;
    font-weight: 700;
  }

  .top-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
    margin-bottom: 16px;
  }

  .field {
    display: flex;
    flex-direction: column;
    font-size: 12px;
  }

  .field label {
    margin-bottom: 4px;
    color: #555;
  }

  .field input, .field textarea {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #cfd3da;
    font-size: 13px;
    min-width: 180px;
  }

  .field textarea {
    min-height: 60px;
    resize: vertical;
  }

  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  button {
    padding: 8px 12px;
    border: none;
    background: #007aff;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: 0.15s;
  }

  button:hover {
    background: #0060d6;
  }

  .layout {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .bucket, .unassigned {
    background: white;
    padding: 16px;
    width: 240px;
    min-height: 230px;
    border-radius: 14px;
    border: 1px solid #d8dce3;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  }

  .bucket h3, .unassigned h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 10px;
  }

  .job {
    padding: 10px;
    background: #fff;
    border: 1px solid #cfd3da;
    border-radius: 10px;
    margin: 8px 0;
    cursor: grab;
    transition: 0.1s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    font-size: 13px;
  }

  .job:hover {
    transform: scale(1.02);
  }

  .job-main {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .job-sub {
    font-size: 11px;
    color: #666;
    display: flex;
    justify-content: space-between;
  }

  .summary {
    margin: 12px 0;
    font-size: 13px;
    color: #555;
  }

  pre {
    background: #1e1e1e;
    color: #00ff99;
    padding: 12px;
    border-radius: 8px;
    max-height: 260px;
    overflow-y: auto;
    margin-top: 16px;
    font-size: 12px;
  }
</style>
</head>

<body>

<h1>WIP Timesheet – MVP2 Batch Outputs</h1>

<div class="top-bar">
  <div class="field">
    <label for="staffCode">Staff Code</label>
    <input id="staffCode" placeholder="e.g. JFELD" />
  </div>
  <div class="field">
    <label for="weekStart">Week Starting (Mon)</label>
    <input id="weekStart" type="date" />
  </div>
  <div class="field" style="flex:1; min-width:240px;">
    <label for="docInput">Description / Notes (used in Word & PPT outline)</label>
    <textarea id="docInput" placeholder="What did you work on this week?"></textarea>
  </div>

  <div class="buttons">
    <button onclick="downloadExcel()">Excel Timesheet</button>
    <button onclick="downloadCsv()">CSV</button>
    <button onclick="downloadJson()">JSON</button>
    <button onclick="downloadWord()">Word Doc</button>
    <button onclick="downloadPptOutline()">PPT Outline (txt)</button>
  </div>
</div>

<div class="summary" id="summary"></div>

<div class="layout">
  <div class="unassigned" ondragover="allow(event)" ondrop="drop(event,'unassigned')">
    <h3>Unassigned Work</h3>
  </div>

  <div class="bucket" ondragover="allow(event)" ondrop="drop(event,'monday')">
    <h3>Monday</h3>
  </div>

  <div class="bucket" ondragover="allow(event)" ondrop="drop(event,'tuesday')">
    <h3>Tuesday</h3>
  </div>

  <div class="bucket" ondragover="allow(event)" ondrop="drop(event,'wednesday')">
    <h3>Wednesday</h3>
  </div>
</div>

<h2>Live JSON (Engine Output)</h2>
<pre id="json"></pre>

<script>
// --- SAMPLE JOB DATA ---
let jobs = [
  {
    id: 1,
    clientCode: "SURF001",
    clientName: "SurfCo",
    jobCode: "AUTOPIPE",
    jobName: "Pipeline Automation",
    hours: 1.5,
    day: "unassigned"
  },
  {
    id: 2,
    clientCode: "MED100",
    clientName: "MedGroup",
    jobCode: "PILLAR2",
    jobName: "Pillar Two Model",
    hours: 2.0,
    day: "unassigned"
  },
  {
    id: 3,
    clientCode: "ZOO777",
    clientName: "Sydney Zoo",
    jobCode: "ESGMAP",
    jobName: "ESG Map Build",
    hours: 3.0,
    day: "unassigned"
  }
];

const dayOffsets = { monday: 0, tuesday: 1, wednesday: 2 };

function getWorkDate(weekStartStr, dayKey) {
  if (!weekStartStr || !dayOffsets.hasOwnProperty(dayKey)) return "";
  const base = new Date(weekStartStr);
  base.setDate(base.getDate() + dayOffsets[dayKey]);
  return base.toISOString().substring(0, 10); // YYYY-MM-DD
}

// Build timesheet rows (common for Excel/CSV)
function buildTimesheetRows() {
  const staffCode = document.getElementById("staffCode").value || "";
  const weekStart = document.getElementById("weekStart").value || "";

  return jobs
    .filter(j => j.day !== "unassigned")
    .map(j => {
      const workDate = getWorkDate(weekStart, j.day);
      const narrative = `${j.jobName} (${j.clientName})`;
      return {
        StaffCode: staffCode,
        WorkDate: workDate,
        ClientCode: j.clientCode,
        JobCode: j.jobCode,
        Hours: j.hours,
        Narrative: narrative
      };
    });
}

// --- RENDERING ---
function render() {
  // Reset buckets but keep headings
  document.querySelectorAll(".bucket,.unassigned").forEach(b => {
    const heading = b.querySelector("h3").innerText;
    b.innerHTML = "<h3>" + heading + "</h3>";
  });

  // Place each job into its bucket
  jobs.forEach(j => {
    let d = document.createElement("div");
    d.className = "job";
    d.draggable = true;
    d.id = "job-" + j.id;

    d.innerHTML = `
      <div class="job-main">${j.clientName} (${j.clientCode})</div>
      <div class="job-sub">
        <span>${j.jobCode} – ${j.jobName}</span>
        <span>${j.hours}h</span>
      </div>
    `;

    d.ondragstart = e => e.dataTransfer.setData("id", j.id);
    document.querySelector(`[ondrop*="${j.day}"]`).appendChild(d);
  });

  // Update JSON view
  document.getElementById("json").innerText = JSON.stringify(jobs, null, 2);

  // Update summary
  updateSummary();
}

function updateSummary() {
  const counts = { unassigned: 0, monday: 0, tuesday: 0, wednesday: 0 };
  jobs.forEach(j => { counts[j.day] = (counts[j.day] || 0) + 1; });

  document.getElementById("summary").innerText =
    `Unassigned: ${counts.unassigned || 0} · ` +
    `Mon: ${counts.monday || 0} · ` +
    `Tue: ${counts.tuesday || 0} · ` +
    `Wed: ${counts.wednesday || 0}`;
}

// --- DRAG/DROP ---
function allow(e) { e.preventDefault(); }

function drop(e, day) {
  e.preventDefault();
  const id = e.dataTransfer.getData("id");
  const job = jobs.find(j => j.id == id);
  job.day = day;
  render();
}

// --- DOWNLOADS ---
// 1) Excel (APS-style)
function downloadExcel() {
  const rows = buildTimesheetRows();
  if (!rows.length) {
    alert("No jobs assigned to days yet.");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Timesheet");
  XLSX.writeFile(wb, "wip_timesheet_aps.xlsx");
}

// 2) CSV
function downloadCsv() {
  const rows = buildTimesheetRows();
  if (!rows.length) {
    alert("No jobs assigned to days yet.");
    return;
  }
  const headers = Object.keys(rows[0]);
  const lines = [headers.join(",")];
  rows.forEach(r => {
    lines.push(headers.map(h => JSON.stringify(r[h] ?? "")).join(","));
  });
  const blob = new Blob([lines.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "wip_timesheet_aps.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// 3) JSON (raw jobs)
function downloadJson() {
  const blob = new Blob([JSON.stringify(jobs, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "wip_jobs.json";
  a.click();
  URL.revokeObjectURL(url);
}

// 4) Word (simple .doc using HTML)
function downloadWord() {
  const notes = document.getElementById("docInput").value || "";
  const rows = buildTimesheetRows();

  let html = `
    <html><body>
    <h1>Weekly Work Summary</h1>
    <p>${notes.replace(/\n/g,"<br>")}</p>
    <h2>Jobs</h2>
    <ul>
  `;
  rows.forEach(r => {
    html += `<li>${r.WorkDate} – ${r.ClientCode}/${r.JobCode} – ${r.Hours}h – ${r.Narrative}</li>`;
  });
  html += "</ul></body></html>";

  const blob = new Blob([html], { type: "application/msword" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "weekly_summary.doc";
  a.click();
  URL.revokeObjectURL(url);
}

// 5) PPT Outline (plain text you can paste into slides)
function downloadPptOutline() {
  const notes = document.getElementById("docInput").value || "";
  const rows = buildTimesheetRows();

  let text = "Weekly Work Outline\n\n";
  if (notes.trim()) {
    text += "Notes:\n" + notes + "\n\n";
  }
  text += "Jobs:\n";
  rows.forEach((r, idx) => {
    text += `${idx + 1}. ${r.WorkDate} – ${r.ClientCode}/${r.JobCode} – ${r.Hours}h – ${r.Narrative}\n`;
  });

  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "weekly_outline_for_ppt.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// --- INITIAL ---
render();
</script>

</body>
</html>
